<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Agendar Cita | HealNet</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <style>
        .booking-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px;
        }

        .booking-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            padding: 40px;
        }

        .booking-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .booking-header h1 {
            font-size: 32px;
            color: #1e3a8a;
            margin-bottom: 10px;
        }

        .booking-header p {
            color: #64748b;
            font-size: 16px;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }

        .step-indicator::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 10%;
            right: 10%;
            height: 2px;
            background: #e2e8f0;
            z-index: 0;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e2e8f0;
            color: #94a3b8;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: 700;
            transition: all 0.3s;
        }

        .step.active .step-number {
            background: #3b82f6;
            color: white;
        }

        .step.completed .step-number {
            background: #10b981;
            color: white;
        }

        .step-label {
            font-size: 13px;
            color: #64748b;
            font-weight: 600;
        }

        .form-section {
            display: none;
            animation: fadeIn 0.3s;
        }

        .form-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #374151;
            font-size: 15px;
        }

        .form-group label .required {
            color: #ef4444;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .doctor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .doctor-card {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .doctor-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            transform: translateY(-2px);
        }

        .doctor-card.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .doctor-card input[type="radio"] {
            display: none;
        }

        .doctor-name {
            font-weight: 700;
            color: #1e3a8a;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .doctor-specialty {
            color: #3b82f6;
            font-size: 14px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .doctor-license {
            color: #64748b;
            font-size: 13px;
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .time-slot {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            background: white;
        }

        .time-slot:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .time-slot.selected {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
        }

        .time-slot input[type="radio"] {
            display: none;
        }

        .summary-box {
            background: #f8fafc;
            border-radius: 12px;
            padding: 25px;
            border: 2px solid #e2e8f0;
            margin-bottom: 25px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            font-weight: 600;
            color: #64748b;
        }

        .summary-value {
            font-weight: 700;
            color: #1e3a8a;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }

        .btn-secondary:hover {
            background: #cbd5e1;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header>
        <div class="topbar">
            <div class="brand-left">
                <div class="brand-text">
                    <div class="name">HealNet</div>
                    <div class="tag">Salud Digital</div>
                </div>
            </div>

            <nav class="primary">
                <a href="{{ url_for('main.dashboard') }}">Inicio</a>
                <a href="{{ url_for('citas.mis_citas') }}">Mis Citas</a>
                <a href="{{ url_for('main.perfil') }}">Mi Perfil</a>
            </nav>

            <div class="user-menu">
                <div>
                    <div class="user-name">{{ current_user.nombre }}</div>
                    <div class="user-role">{{ current_user.rol }}</div>
                </div>
                <a href="{{ url_for('auth.logout') }}" style="color: #fff; text-decoration: none; font-weight: 700;">Salir →</a>
            </div>
        </div>
    </header>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flashes" style="max-width: 900px; margin: 20px auto; padding: 0 30px;">
                {% for category, message in messages %}
                    <div class="flash {{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="booking-container">
        <div class="booking-card">
            <div class="booking-header">
                <h1>📅 Agendar Nueva Cita</h1>
                <p>Completa los siguientes pasos para agendar tu cita médica</p>
            </div>

            <!-- INDICADOR DE PASOS -->
            <div class="step-indicator">
                <div class="step active" id="step-indicator-1">
                    <div class="step-number">1</div>
                    <div class="step-label">Especialidad</div>
                </div>
                <div class="step" id="step-indicator-2">
                    <div class="step-number">2</div>
                    <div class="step-label">Doctor</div>
                </div>
                <div class="step" id="step-indicator-3">
                    <div class="step-number">3</div>
                    <div class="step-label">Fecha y Hora</div>
                </div>
                <div class="step" id="step-indicator-4">
                    <div class="step-number">4</div>
                    <div class="step-label">Detalles</div>
                </div>
                <div class="step" id="step-indicator-5">
                    <div class="step-number">5</div>
                    <div class="step-label">Confirmar</div>
                </div>
            </div>

            <form method="POST" id="bookingForm">
                <!-- PASO 1: ESPECIALIDAD -->
                <div class="form-section active" id="section-1">
                    <h2 style="margin-bottom: 20px; color: #1e3a8a;">Selecciona la Especialidad</h2>
                    
                    {% if especialidades %}
                    <div class="form-group">
                        <select id="especialidadSelect" class="especialidad-select" required>
                            <option value="">-- Selecciona una especialidad --</option>
                            {% for esp in especialidades %}
                            <option value="{{ esp }}">{{ esp }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon">🩺</div>
                        <p>No hay especialidades disponibles en este momento</p>
                    </div>
                    {% endif %}

                    <div class="btn-group">
                        <button type="button" class="btn btn-primary" onclick="nextStep(2)" id="btnStep1">
                            Siguiente →
                        </button>
                    </div>
                </div>

                <!-- PASO 2: DOCTOR -->
                <div class="form-section" id="section-2">
                    <h2 style="margin-bottom: 20px; color: #1e3a8a;">Selecciona el Doctor</h2>
                    
                    <div id="doctoresContainer" class="doctor-grid">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <p>Cargando doctores...</p>
                        </div>
                    </div>

                    <input type="hidden" name="doctor_id" id="doctorId" required>

                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="prevStep(1)">
                            ← Atrás
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextStep(3)" id="btnStep2">
                            Siguiente →
                        </button>
                    </div>
                </div>

                <!-- PASO 3: FECHA Y HORA -->
                <div class="form-section" id="section-3">
                    <h2 style="margin-bottom: 20px; color: #1e3a8a;">Selecciona Fecha y Hora</h2>
                    
                    <div class="form-group">
                        <label>Fecha de la Cita <span class="required">*</span></label>
                        <input type="date" name="fecha" id="fechaInput" required onchange="cargarHorarios()">
                    </div>

                    <div class="form-group">
                        <label>Hora Disponible <span class="required">*</span></label>
                        <div id="horariosContainer" class="time-slots">
                            <div class="alert alert-info">
                                Por favor selecciona una fecha para ver los horarios disponibles
                            </div>
                        </div>
                    </div>

                    <input type="hidden" name="hora" id="horaInput" required>

                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="prevStep(2)">
                            ← Atrás
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextStep(4)" id="btnStep3">
                            Siguiente →
                        </button>
                    </div>
                </div>

                <!-- PASO 4: DETALLES -->
                <div class="form-section" id="section-4">
                    <h2 style="margin-bottom: 20px; color: #1e3a8a;">Detalles de la Consulta</h2>
                    
                    <div class="form-group">
                        <label>Motivo de la Consulta <span class="required">*</span></label>
                        <input type="text" name="motivo" id="motivoInput" required placeholder="Ej: Control general, dolor de cabeza, etc.">
                    </div>

                    <div class="form-group">
                        <label>Síntomas o Detalles Adicionales</label>
                        <textarea name="sintomas" id="sintomasInput" placeholder="Describe tus síntomas o cualquier información adicional que el doctor deba conocer..."></textarea>
                    </div>

                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="prevStep(3)">
                            ← Atrás
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextStep(5)">
                            Siguiente →
                        </button>
                    </div>
                </div>

                <!-- PASO 5: CONFIRMACIÓN -->
                <div class="form-section" id="section-5">
                    <h2 style="margin-bottom: 20px; color: #1e3a8a;">Confirmar Cita</h2>
                    
                    <div class="summary-box">
                        <div class="summary-item">
                            <span class="summary-label">👨‍⚕️ Doctor:</span>
                            <span class="summary-value" id="summaryDoctor">-</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">🩺 Especialidad:</span>
                            <span class="summary-value" id="summaryEspecialidad">-</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">📅 Fecha:</span>
                            <span class="summary-value" id="summaryFecha">-</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">🕐 Hora:</span>
                            <span class="summary-value" id="summaryHora">-</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">📝 Motivo:</span>
                            <span class="summary-value" id="summaryMotivo">-</span>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        💡 Recibirás un recordatorio por correo electrónico antes de tu cita
                    </div>

                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="prevStep(4)">
                            ← Atrás
                        </button>
                        <button type="submit" class="btn btn-primary">
                            ✅ Confirmar y Agendar Cita
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let selectedDoctor = null;
        let selectedEspecialidad = null;
        let doctoresData = {{ doctores | tojson }};

        // Configurar fecha mínima (hoy)
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('fechaInput').min = today;

        // NAVEGACIÓN ENTRE PASOS
        function nextStep(step) {
            // Validar paso actual
            if (!validateStep(currentStep)) {
                return;
            }

            // Ocultar paso actual
            document.getElementById(`section-${currentStep}`).classList.remove('active');
            document.getElementById(`step-indicator-${currentStep}`).classList.add('completed');
            
            // Mostrar nuevo paso
            document.getElementById(`section-${step}`).classList.add('active');
            document.getElementById(`step-indicator-${step}`).classList.add('active');
            
            currentStep = step;

            // Actualizar resumen si estamos en el paso 5
            if (step === 5) {
                actualizarResumen();
            }
        }

        function prevStep(step) {
            document.getElementById(`section-${currentStep}`).classList.remove('active');
            document.getElementById(`step-indicator-${currentStep}`).classList.remove('active');
            
            document.getElementById(`section-${step}`).classList.add('active');
            document.getElementById(`step-indicator-${currentStep}`).classList.remove('completed');
            
            currentStep = step;
        }

        // VALIDACIONES
        function validateStep(step) {
            if (step === 1) {
                const especialidad = document.getElementById('especialidadSelect').value;
                if (!especialidad) {
                    alert('Por favor selecciona una especialidad');
                    return false;
                }
                selectedEspecialidad = especialidad;
                cargarDoctoresPorEspecialidad(especialidad);
                return true;
            }
            
            if (step === 2) {
                if (!selectedDoctor) {
                    alert('Por favor selecciona un doctor');
                    return false;
                }
                return true;
            }
            
            if (step === 3) {
                const fecha = document.getElementById('fechaInput').value;
                const hora = document.getElementById('horaInput').value;
                if (!fecha || !hora) {
                    alert('Por favor selecciona una fecha y hora');
                    return false;
                }
                return true;
            }
            
            if (step === 4) {
                const motivo = document.getElementById('motivoInput').value.trim();
                if (!motivo) {
                    alert('Por favor ingresa el motivo de la consulta');
                    return false;
                }
                return true;
            }
            
            return true;
        }

        // CARGAR DOCTORES POR ESPECIALIDAD
        function cargarDoctoresPorEspecialidad(especialidad) {
            const container = document.getElementById('doctoresContainer');
            container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Cargando doctores...</p></div>';
            
            fetch(`/citas/api/doctores-por-especialidad/${encodeURIComponent(especialidad)}`)
                .then(response => response.json())
                .then(doctores => {
                    if (doctores.length === 0) {
                        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">👨‍⚕️</div><p>No hay doctores disponibles para esta especialidad</p></div>';
                        return;
                    }
                    
                    let html = '';
                    doctores.forEach(doctor => {
                        html += `
                            <label class="doctor-card" onclick="seleccionarDoctor(${doctor.id}, '${doctor.nombre}', '${doctor.especialidad}')">
                                <input type="radio" name="doctor_radio" value="${doctor.id}">
                                <div class="doctor-name">${doctor.nombre}</div>
                                <div class="doctor-specialty">🩺 ${doctor.especialidad}</div>
                                <div class="doctor-license">Lic. ${doctor.licencia || 'N/A'}</div>
                            </label>
                        `;
                    });
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error:', error);
                    container.innerHTML = '<div class="alert alert-danger">Error al cargar doctores</div>';
                });
        }

        // SELECCIONAR DOCTOR
        function seleccionarDoctor(id, nombre, especialidad) {
            selectedDoctor = { id, nombre, especialidad };
            document.getElementById('doctorId').value = id;
            
            // Actualizar UI
            document.querySelectorAll('.doctor-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        // CARGAR HORARIOS DISPONIBLES
        function cargarHorarios() {
            const fecha = document.getElementById('fechaInput').value;
            const doctorId = document.getElementById('doctorId').value;
            
            if (!fecha || !doctorId) return;
            
            const container = document.getElementById('horariosContainer');
            container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Cargando horarios...</p></div>';
            
            fetch(`/citas/api/horarios-disponibles/${doctorId}/${fecha}`)
                .then(response => response.json())
                .then(horarios => {
                    if (horarios.length === 0) {
                        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">🕐</div><p>No hay horarios disponibles para esta fecha</p></div>';
                        return;
                    }
                    
                    let html = '';
                    horarios.forEach(horario => {
                        html += `
                            <label class="time-slot" onclick="seleccionarHora('${horario.hora}')">
                                <input type="radio" name="hora_radio" value="${horario.hora}">
                                ${horario.hora}
                            </label>
                        `;
                    });
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error:', error);
                    container.innerHTML = '<div class="alert alert-danger">Error al cargar horarios</div>';
                });
        }

        // SELECCIONAR HORA
        function seleccionarHora(hora) {
            document.getElementById('horaInput').value = hora;
            
            // Actualizar UI
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        // ACTUALIZAR RESUMEN
        function actualizarResumen() {
            const fecha = document.getElementById('fechaInput').value;
            const hora = document.getElementById('horaInput').value;
            const motivo = document.getElementById('motivoInput').value;
            
            document.getElementById('summaryDoctor').textContent = selectedDoctor ? `${selectedDoctor.nombre}` : '-';
            document.getElementById('summaryEspecialidad').textContent = selectedEspecialidad || '-';
            document.getElementById('summaryFecha').textContent = fecha ? formatearFecha(fecha) : '-';
            document.getElementById('summaryHora').textContent = hora || '-';
            document.getElementById('summaryMotivo').textContent = motivo || '-';
        }

        // FORMATEAR FECHA
        function formatearFecha(fecha) {
            const [year, month, day] = fecha.split('-');
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            return `${day} de ${meses[parseInt(month) - 1]} de ${year}`;
        }
    </script>
</body>
</html>